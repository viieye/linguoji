<body style="background-color: #222;">
    <canvas id="canv" width="250" height="200"></canvas>
</body>

<script type="text/javascript" charset="utf-8">
setTimeout(render,50)

var plan = {
    verts:[
        [-1,-1,0],[-1,-1,0],
        [-1,1,0],[-1,1,0],],
    edges:[
        [0,1],[0,2],
        [1,3],[2,3],],
    trigs:[
        [0,1,3],[0,3,2],],
}
var voxl = {
    verts:[
        [-1,-1,-1],[-1,-1,1],
        [-1,1,-1],[-1,1,1],
        [1,-1,-1],[1,-1,1],
        [1,1,-1],[1,1,1],],
    edges:[
        [0,1],[0,2],[0,4],
        [1,3],[4,5],[2,6],
        [1,5],[4,6],[2,3],
        [5,7],[6,7],[3,7]],
    trigs:[
        [0,1,5],[0,5,4],
        [0,4,6],[0,6,2],
        [0,2,3],[0,3,1],
        [1,3,7],[5,1,7],
        [4,5,7],[6,4,7],
        [2,6,7],[3,2,7]],
}

var canvas = document.getElementById('canv')
var contxt = canvas.getContext('2d')

// color hue(0-360) saturation(0-100) luminusoty(0-100) roughness(0-100) metalicity(0-100) 
var obj0 = {
    geom:voxl,
    colr:[360,0,100,100,0],
    orntx:[0,0,0],
    locto:[0,0,1.1],
    scale:[1,1,2],
}
var obj1 = {
    geom:voxl,
    colr:[360,100,75,100,0],
    orntx:[0,30,0],
    locto:[3,0,0.1],
    scale:[1,1,1],
}
var obj2 = {
    geom:voxl,
    colr:[360,0,75,100,0],
    orntx:[0,0,0],
    locto:[0,3,0.1],
    scale:[1,1,1],
}
var flor = {
    geom:plan,
    colr:[360,0,50,100,0],
    orntx:[0,0,0],
    locto:[0,0,-1],
    scale:[5,5,1],
}

var scene = [flor,obj1,obj2,obj0,]
// var scene = [obj0,]
var camra = {
    // orntx:[-90,0,45],
    orntx:[-90,0,10],
    locto:[0,-4,0],
    dimen:[1000,800],
    aptrz:[8,8]
}
canvas.width = camra.dimen[0]
canvas.height =camra.dimen[1]

function render() {
    contxt.clearRect(0,0,camra.dimen[0],camra.dimen[1])
    for (let i = 0; i<scene.length; i++) {
        objrender(i)
    }
}

function objrender(ind) {
    let objgeo = scene[ind].geom
    contxt.textAlign = "center";
    contxt.textBaseline = "middle";
    for (let i = 0; i < objgeo.trigs.length; i++) {
        let worktrig = objgeo.trigs[i]
        let verts = []
        for (let itr = 0; itr < worktrig.length; itr++) {
            let vert = convvert(trans([objgeo.verts[worktrig[itr]]]),ind)
            verts.push(vert)
        }
        // console.log(trans(verts[0])[0])
        // console.log(trans(verts[1])[0])
        // console.log(trans(verts[2])[0])
        contxt.beginPath()
        contxt.moveTo(camcnvrt(verts[0])[0],camcnvrt(verts[0])[1],)
        let vctrs = []
        for (let i = 0; i < verts.length; i++) {
            vctrs.push(matrxadd(verts[i],verts[(i-1+verts.length)%verts.length],1,-1))
            let vert = verts[i]
            let vertr = camcnvrt(vert)
            contxt.lineTo(vertr[0],vertr[1])
        }
        let normalvk = matrxnrm(crsprodd(vctrs[1],vctrs[0]))
        let avrgvctr = matrxadd(verts[0],matrxadd(verts[1],verts[2],1,1),1/3,2/3)
        console.log(avrgvctr,vctrs);
        

        contxt.fillStyle = "hsl("+ [scene[ind].colr[0],scene[ind].colr[1]+"%",scene[ind].colr[2]*dotprodd(trans(normalvk)[0],[0,1,1])+"%"]+")"

        if (dotprodd(trans(normalvk)[0],avrgvctr)<0) {
            contxt.fill()
        }

        contxt.beginPath()
        // contxt.moveTo(camcnvrt(avrgvctr)[0],camcnvrt(avrgvctr)[1],)
        contxt.moveTo(camcnvrt(convvert(trans([scene[ind].locto]),ind))[0],camcnvrt(convvert(trans([scene[ind].locto]),ind))[1],)
        contxt.lineTo(camcnvrt(avrgvctr)[0],camcnvrt(avrgvctr)[1],)
        contxt.lineTo(camcnvrt(matrxadd(avrgvctr,normalvk,1,1))[0],camcnvrt(matrxadd(avrgvctr,normalvk,1,1))[1],)
        contxt.strokeStyle = "#f00"
        contxt.stroke()

        // console.log(contxt.fillStyle)
        // console.log(trans(normalvk)[0]);
        
        let norml = 0


    }
    for (let i = 0; i < objgeo.verts.length; i++) {
        let vert = convvert(trans([objgeo.verts[i]]),ind)
        let vertr = camcnvrt(vert)
        contxt.fillStyle="#0ff"
        contxt.fillText([ind,i].toString(),vertr[0],vertr[1])
    }
}

// setInterval(main,100)
function main() {
    render()
    scene[1].orntx[2]+=10
    // camra.orntx[2]+=-9
}

function convvert(vert3,ind) {
    let mtrsc = [
        [scene[ind].scale[0],0,0],
        [0,scene[ind].scale[1],0],
        [0,0,scene[ind].scale[2]],]
    vert3 = matrxmul(mtrsc,vert3)

    vert3 = matrxmul(rot2matr(scene[ind].orntx,1),vert3)
    vert3 = matrxadd(vert3,trans([scene[ind].locto]),1,1)

    vert3 = matrxadd(vert3,trans([camra.locto]),1,-1)
    let camor = [camra.orntx[0],camra.orntx[1],camra.orntx[2]]
    return matrxmul(rot2matr(camor,1),vert3)
}

function camcnvrt(vert3) {
    let zval = -vert3[2][0]
    let vertx = vert3[0][0]*camra.dimen[0]/Math.sqrt(zval)/camra.aptrz[0]+camra.dimen[0]/2
    let verty = camra.dimen[1]-vert3[1][0]*camra.dimen[1]/Math.sqrt(zval)/camra.aptrz[1]-camra.dimen[1]/2
    return [vertx,verty]
}

function crsprodd(matr1,matr2) {
    let ans=0
    let calkmatr = [
        [0,-matr1[2][0],matr1[1][0]],
        [matr1[2][0],0,-matr1[0][0]],
        [-matr1[1][0],matr1[0][0],0]]
    return matrxmul(calkmatr,matr2)
}

function dotprodd(m1v1,m1v2) {
    let ans=0
    for (let i =0;i<m1v1.length;i++) {
        ans+=m1v1[i]*m1v2[i]
    }
    return ans
}

function trans(m1) {
    let ansmatr = []
    for (let i=0;i<m1[0].length;i++) {
        let anscol = []
        for (let itr = 0; itr < m1.length; itr++) {
            anscol.push(m1[itr][i])
        }
        ansmatr.push(anscol)
    }
    return ansmatr
}

function matrxadd(matr1,matr2,mul1,mul2) {
    // console.log(matr1,matr2);
    let ansmatr = []
    for (let j=0;j<matr1.length;j++) {
        let ansrow = []
        for (let i=0;i<matr1[j].length;i++) {
            ansrow.push(matr1[j][i]*mul1+matr2[j][i]*mul2)
        }
        ansmatr.push(ansrow)
    }
    // console.log(ansmatr,matr1,matr2);
    
    return ansmatr
}

function matrxmul(matr1,matr2) {
    // console.log(matr1,matr2);
    
    let ansmatr = []
    for (let j=0;j<matr1.length;j++) {
        let ansrow = []
        for (let i=0;i<matr2[0].length;i++) {
            let m1v1 = matr1[j]
            let m1v2 = []
            for (let itr=0;itr<matr2.length;itr++) {
                m1v2.push(matr2[itr][i])
            }
            let dtprd = dotprodd(m1v1,m1v2)
            ansrow.push(dtprd)
        }
        ansmatr.push(ansrow)
    }
    return ansmatr
}

function rot2matr(xyzmatr,isdeg) {
    
    let rx = (isdeg==1)?Math.PI*(xyzmatr[0])/180:xyzmatr[0]
    let ry = (isdeg==1)?Math.PI*(xyzmatr[1])/180:xyzmatr[1]
    let rz = (isdeg==1)?Math.PI*(xyzmatr[2])/180:xyzmatr[2]

    // console.log(xyzmatr,rx,ry,rz);

    var sin = [Math.sin(rx),Math.sin(ry),Math.sin(rz),]
    var cos = [Math.cos(rx),Math.cos(ry),Math.cos(rz),]

    let rtxmt = [
        [1,0,0],
        [0,cos[0],-sin[0]],
        [0,sin[0],cos[0]],]
    let rtymt = [
        [cos[1],0,sin[1]],
        [0,1,0],
        [-sin[1],0,cos[1]],]
    let rtzmt = [
        [cos[2],-sin[2],0],
        [sin[2],cos[2],0],
        [0,0,1],]
    return matrxmul(matrxmul(rtxmt,rtymt),rtzmt,)
}

function matrxnrm(matrx) {
    let len = Math.sqrt(matrx[0]*matrx[0]+matrx[1]*matrx[1]+matrx[2]*matrx[2])
    return matrxadd(matrx,matrx,1/len,0)
}
</script>